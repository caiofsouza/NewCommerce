"use strict";var API_HOST="http://localhost:3000/api/",app=angular.module("newCommerce",["ngRoute","ngCookies","ui.utils.masks","ngSanitize","ui.select"]);app.filter("propsFilter",function(){return function(items,props){var out=[];return angular.isArray(items)?items.forEach(function(item){for(var itemMatches=!1,keys=Object.keys(props),i=0;i<keys.length;i++){var prop=keys[i],text=props[prop].toLowerCase();if(-1!==item[prop].toString().toLowerCase().indexOf(text)){itemMatches=!0;break}}itemMatches&&out.push(item)}):out=items,out}}),app.config(["$locationProvider","$routeProvider","$httpProvider",function($locationProvider,$routeProvider,$httpProvider){$routeProvider.when("/",{templateUrl:"views/login.html",controller:"LoginCtrl",title:"Login",needAuth:!1}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl",title:"Login",needAuth:!1}).when("/home",{templateUrl:"views/home.html",controller:"HomeCtrl",title:"Home",needAuth:!0}).when("/products",{templateUrl:"views/products.html",controller:"ProductsCtrl",title:"Produtos",needAuth:!0}).when("/products/new",{templateUrl:"views/new_product.html",controller:"ProductCtrl",title:"Novo Produto",needAuth:!0}).when("/product/:product_id",{templateUrl:"views/product.html",controller:"ProductCtrl",title:"Produto",needAuth:!0}).when("/categories",{templateUrl:"views/categories.html",controller:"CategoriesCtrl",title:"Categorias",needAuth:!0}).when("/categories/new",{templateUrl:"views/new_category.html",controller:"CategoryCtrl",title:"Nova Categoria",needAuth:!0}).when("/category/:category_id",{templateUrl:"views/category.html",controller:"CategoryCtrl",title:"Categoria",needAuth:!0}).when("/orders/:order_id",{templateUrl:"views/order.html",controller:"OrderCtrl",title:"Pedido",needAuth:!0}).when("/orders",{templateUrl:"views/orders.html",controller:"OrdersCtrl",title:"Pedidos",needAuth:!0}),$routeProvider.otherwise({redirectTo:"/home"}),$locationProvider.html5Mode(!0)}]),app.run(["$rootScope","$location","$route","Auth","$http","$interval",function($rootScope,$location,$route,Auth,$http,$interval){var auth=new Auth;auth.checkUser(function(cookie_obj){cookie_obj&&($http.defaults.headers.common["x-access-token"]=cookie_obj.token)}),$rootScope.$on("$routeChangeStart",function(event,next,current){$rootScope.path=$location.path(),auth.checkUser(function(cookie_obj){cookie_obj&&($http.defaults.headers.common["x-access-token"]=cookie_obj.token);var nextPath=$location.path();$route.routes[nextPath];1==next.needAuth&&void 0==cookie_obj?$location.path("/login"):"/login"!=nextPath&&"/"!=nextPath||void 0==cookie_obj||$location.path("/home")})}),$rootScope.$on("$routeChangeSuccess",function(event,current,previous){$rootScope.title=$route.current.title})}]),app.controller("CategoriesCtrl",["$scope","$cookies","$location","$http",function($scope,$cookies,$location,$http){var self=this;self.user=JSON.parse($cookies.get("api_auth")).user,self.allCategories=[],self.onEdition="",self.category={name:"",sub_cats:[]},self.messageAdd="",self.getAllCategories=function(){self.inLoading=!0,$http.get(API_HOST+"categories").then(function(res){self.allCategories=res.data.sort(function(a,b){return a.name.toLowerCase()>b.name.toLowerCase()?1:a.name.toLowerCase()<b.name.toLowerCase()?-1:0}),self.inLoading=!1})},self.getAllCategories(),self.saveCategory=function(){self.messageAdd="",""!=self.category.name?(self.inLoading=!0,$http.post(API_HOST+"category",self.category).then(function(res){res.data.result&&(self.category={name:"",sub_cats:[]},self.allCategories.push(res.data.result),self.allCategories=self.allCategories.sort(function(a,b){return a.name.toLowerCase()>b.name.toLowerCase()?1:a.name.toLowerCase()<b.name.toLowerCase()?-1:0}),self.messageAdd="Categoria adicionada com sucesso!",self.inLoading=!1)})):self.messageAdd="Preencha o campo de nome!"},self.logout=function(){$cookies.remove("api_auth"),$location.path("/login")},self.edit=function(cat_id){var hideAll=self.allCategories.filter(function(el){return el.visible===!0});hideAll.length>0&&(hideAll[0].visible=!1);var selectedCategory=self.allCategories.filter(function(el){return el._id===cat_id});hideAll.length>0&&hideAll[0]._id==cat_id?""!=selectedCategory[0].name&&$http.put(API_HOST+"category/"+cat_id,selectedCategory[0]).then(function(res){selectedCategory[0].btnStatus="Editar",selectedCategory[0].visible=!1}):(selectedCategory[0].btnStatus="Salvar",selectedCategory[0].visible=!0)}}]),app.controller("HomeCtrl",["$cookies","$location",function($cookies,$location){var self=this;self.user=JSON.parse($cookies.get("api_auth")).user,self.logout=function(){$cookies.remove("api_auth"),$location.path("/login")}}]),app.controller("LoginCtrl",["$location","Auth","$http",function($location,Auth,$http){var self=this;self.user_email="",self.user_password="",self.auth=new Auth,self.user_login=function(){if(self.messageError="",""!=self.user_email&&""!=self.user_password){self.email_error=self.pass_error=!1;var user_obj={email:self.user_email,password:self.user_password};self.auth.loginUser(user_obj,function(result){1==result?$location.path("/home").replace():self.messageError="Usuário ou senha incorretos!"})}else""==self.user_email?(self.email_error=!0,self.messageError="Preencha o campo de email"):(self.pass_error=!0,self.messageError="Preencha o campo de senha")}}]),app.controller("OrdersCtrl",["$scope","$cookies","$location","$http",function($scope,$cookies,$location,$http){var self=this;self.allOrders=[],self.user=JSON.parse($cookies.get("api_auth")).user,self.logout=function(){$cookies.remove("api_auth"),$location.path("/login")},self.getAllOrders=function(){$http.get(API_HOST+"orders").then(function(res){res.data&&console.log(res.data)})},self.allOrders=self.getAllOrders()}]),app.controller("ProductCtrl",["$location","$routeParams","$cookies","$http",function($location,$routeParams,$cookies,$http){var self=this;if(self.user=JSON.parse($cookies.get("api_auth")).user,self.messageError="",self.product={available_marketplace:!1,active:!1,tags:[]},self.inLoading=!1,self.allTags=[],self.selectedCategories=[],self.allCategories=[],self.getAllTags=function(){self.inLoading=!0,$http.get(API_HOST+"tags").then(function(res){self.allTags=res.data,self.inLoading=!1})},self.getAllTags(),self.getAllCategories=function(){self.inLoading=!0,$http.get(API_HOST+"categories").then(function(res){self.allCategories=res.data,self.inLoading=!1})},self.getAllCategories(),self.getProductById=function(product_id){self.inLoading=!0,$http.get(API_HOST+"product/"+product_id).then(function(res){self.product=res.data,console.log(self.product.categories),self.selectedCategories=self.product.categories,self.inLoading=!1})},$routeParams.product_id){self.getProductById($routeParams.product_id)}self.save=function(){self.validForm(function(hasError){hasError||(self.inLoading=!0,console.log(self.product),$http.post(API_HOST+"product/",self.product).then(function(res){res.data.result&&(self.messageError="Produto adicionado com sucesso!",self.product={available_marketplace:!1,active:!1,tags:[]}),self.inLoading=!1}))})},self.update=function(){self.validForm(function(hasError){hasError||(self.inLoading=!0,$http.put(API_HOST+"product/"+self.product._id,self.product).then(function(res){res.data.message&&(self.messageError="Produto alterado com sucesso!",self.product=res.data.result),self.inLoading=!1}))})},self.validForm=function(fnCallback){var hasError=!1;self.messageError="",self.product_name_error=self.product_code_error=self.product_price_error=self.product_stock_error=self.product_description_error=!1,""==self.product.name||void 0==self.product.name?(self.product_name_error=!0,self.messageError="Preencha o campo de nome",hasError=!0):""==self.product.code||void 0==self.product.code?(self.product_code_error=!0,self.messageError="Preencha o campo de código",hasError=!0):""==self.product.price||void 0==self.product.price?(self.product_price_error=!0,self.messageError="Preencha o campo de preço",hasError=!0):""==self.product.stock||void 0==self.product.stock?(self.product_stock_error=!0,self.messageError="Preencha o campo de estoque",hasError=!0):""!=self.product.description&&void 0!=self.product.description||(self.product_description_error=!0,self.messageError="Preencha o campo de descrição",hasError=!0),void 0!=fnCallback&&fnCallback(hasError)},self.newUrl=function(name){var new_url=name.toLowerCase();return new_url=new_url.replace(/[^\w\s]/gi,"").replace(/\s/g,"-")},self.updateUrl=function(value){self.product.url=self.newUrl(value)},self.validateUrl=function(){var notAllowSpecialChars=/\`|\~|\!|\@|\#|\$|\%|\^|\&|\*|\(|\)|\+|\=|\[|\{|\]|\}|\||\\|\'|\<|\,|\.|\>|\?|\/|\""|\;|\:|\_/g;self.product.url=self.product.url.replace(/\s/g,"-").replace(notAllowSpecialChars,"").toLowerCase()},self.tagsToLower=function(){if(self.product.tags.length<=0)self.product.tags=[];else{var tags=[],notAllowSpecialChars=/\`|\~|\!|\@|\#|\$|\%|\^|\&|\*|\(|\)|\+|\=|\[|\{|\]|\}|\||\\|\'|\<|\,|\.|\>|\?|\/|\""|\;|\:|\_|\s/g;self.product.tags.forEach(function(el,ind){tags.push(el.replace(notAllowSpecialChars,"").toLowerCase())}),self.product.tags=tags}},self.logout=function(){$cookies.remove("api_auth"),$location.path("/login")}}]),app.controller("ProductsCtrl",["$cookies","$http","$location",function($cookies,$http,$location){var self=this;self.user=JSON.parse($cookies.get("api_auth")).user,self.searchProduct=function(){""!=self.search_input&&void 0!=self.search_input?$http.get(API_HOST+"search-products/"+self.search_input).then(function(res){self.products=res.data,self.count=self.products.length}):self.getAllProducts()},self.getAllProducts=function(){$http.get(API_HOST+"products").then(function(res){self.products=res.data,self.count=self.products.length})},self.logout=function(){$cookies.remove("api_auth"),$location.path("/login")},self.count=0,self.getAllProducts()}]),app.factory("Auth",["$http","$location","$cookies",function($http,$location,$cookies){function Auth(){this.token="",this.loginUser=function(user_obj,fncallback){$http({method:"POST",url:API_HOST+"login/",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(obj){var str=[];for(var p in obj)str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]));return str.join("&")},data:{email:user_obj.email,password:user_obj.password}}).then(function(response){$cookies.put("api_auth",JSON.stringify(response.data)),void 0!=fncallback&&fncallback(!0)},function(response){void 0!=fncallback&&fncallback(!1)})},this.checkUser=function(fncallback){var token=void 0!=$cookies.get("api_auth")?JSON.parse($cookies.get("api_auth")):void 0;void 0!=fncallback&&fncallback(token)}}return Auth}]),$(function(){$(document).on("click",".dropdown",function(e){e.preventDefault(),$(this).find(".dropdown-submenu").slideToggle(200)})});