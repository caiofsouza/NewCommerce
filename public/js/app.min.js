"use strict";var API_HOST="http://localhost:3000/api/",app=angular.module("newCommerce",["ngRoute","ngCookies"]);app.config(["$locationProvider","$routeProvider","$httpProvider",function($locationProvider,$routeProvider,$httpProvider){$routeProvider.when("/",{templateUrl:"views/login.html",controller:"LoginCtrl",title:"Login",needAuth:!1}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl",title:"Login",needAuth:!1}).when("/home",{templateUrl:"views/home.html",controller:"HomeCtrl",title:"Home",needAuth:!0}).when("/products",{templateUrl:"views/products.html",controller:"ProductsCtrl",title:"Produtos",needAuth:!0}).when("/products/new",{templateUrl:"views/new_product.html",controller:"ProductCtrl",title:"Novo Produto",needAuth:!0}).when("/product/:product_id",{templateUrl:"views/product.html",controller:"ProductCtrl",title:"Produto",needAuth:!0}),$routeProvider.otherwise({redirectTo:"/home"}),$locationProvider.html5Mode(!0)}]),app.run(["$rootScope","$location","$route","Auth","$http",function($rootScope,$location,$route,Auth,$http){var auth=new Auth;auth.checkUser(function(cookie_obj){cookie_obj&&($http.defaults.headers.common["x-access-token"]=cookie_obj.token)}),$rootScope.$on("$routeChangeStart",function(event,next,current){$rootScope.path=$location.path(),auth.checkUser(function(cookie_obj){cookie_obj&&($http.defaults.headers.common["x-access-token"]=cookie_obj.token);var nextPath=$location.path();$route.routes[nextPath];1==next.needAuth&&void 0==cookie_obj?$location.path("/login"):"/login"!=nextPath&&"/"!=nextPath||void 0==cookie_obj||$location.path("/home")})}),$rootScope.$on("$routeChangeSuccess",function(current,previous){$rootScope.title=current.title})}]),app.controller("HomeCtrl",["$cookies","$location",function($cookies,$location){var self=this;self.user=JSON.parse($cookies.get("api_auth")).user,self.logout=function(){$cookies.remove("api_auth"),$location.path("/login")}}]),app.controller("LoginCtrl",["$location","Auth","$http",function($location,Auth,$http){var self=this;self.user_email="",self.user_password="",self.auth=new Auth,self.user_login=function(){if(self.messageError="",""!=self.user_email&&""!=self.user_password){self.email_error=self.pass_error=!1;var user_obj={email:self.user_email,password:self.user_password};self.auth.loginUser(user_obj,function(result){1==result?$location.path("/home").replace():self.messageError="Usu√°rio ou senha incorretos!"})}else""==self.user_email?(self.email_error=!0,self.messageError="Preencha o campo de email"):(self.pass_error=!0,self.messageError="Preencha o campo de senha")}}]),app.controller("ProductCtrl",["$routeParams","$cookies",function($routeParams,$cookies){var self=this;$routeParams.product_id&&(self.product_id=$routeParams.product_id),self.user=JSON.parse($cookies.get("api_auth")).user,self.logout=function(){$cookies.remove("api_auth"),$location.path("/login")}}]),app.controller("ProductsCtrl",["$cookies","$http","$location",function($cookies,$http,$location){var self=this;self.user=JSON.parse($cookies.get("api_auth")).user,self.searchProduct=function(){""!=self.search_input&&void 0!=self.search_input?$http.get(API_HOST+"search-products/"+self.search_input).then(function(res){self.products=res.data,self.count=self.products.length}):self.getAllProducts()},self.getAllProducts=function(){$http.get(API_HOST+"products").then(function(res){self.products=res.data,self.count=self.products.length})},self.logout=function(){$cookies.remove("api_auth"),$location.path("/login")},self.count=0,self.getAllProducts()}]),app.factory("Auth",["$http","$location","$cookies",function($http,$location,$cookies){function Auth(){this.token="",this.loginUser=function(user_obj,fncallback){$http({method:"POST",url:API_HOST+"login/",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(obj){var str=[];for(var p in obj)str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]));return str.join("&")},data:{email:user_obj.email,password:user_obj.password}}).then(function(response){$cookies.put("api_auth",JSON.stringify(response.data)),void 0!=fncallback&&fncallback(!0)},function(response){void 0!=fncallback&&fncallback(!1)})},this.checkUser=function(fncallback){var token=void 0!=$cookies.get("api_auth")?JSON.parse($cookies.get("api_auth")):void 0;void 0!=fncallback&&fncallback(token)}}return Auth}]),$(function(){$(document).on("click",".dropdown",function(e){e.preventDefault(),$(this).find(".dropdown-submenu").slideToggle(200)})});