"use strict";var API_HOST="http://localhost:3000/api/",app=angular.module("newCommerce",["ngRoute","ngCookies","ui.utils.masks","ngSanitize","ui.select"]);app.config(["$locationProvider","$routeProvider","$httpProvider",function($locationProvider,$routeProvider,$httpProvider){$routeProvider.when("/",{templateUrl:"views/login.html",controller:"LoginCtrl",title:"Login",needAuth:!1}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl",title:"Login",needAuth:!1}).when("/home",{templateUrl:"views/home.html",controller:"HomeCtrl",title:"Home",needAuth:!0}).when("/products",{templateUrl:"views/products.html",controller:"ProductsCtrl",title:"Produtos",needAuth:!0}).when("/products/new",{templateUrl:"views/new_product.html",controller:"ProductCtrl",title:"Novo Produto",needAuth:!0}).when("/product/:product_id",{templateUrl:"views/product.html",controller:"ProductCtrl",title:"Produto",needAuth:!0}),$routeProvider.otherwise({redirectTo:"/home"}),$locationProvider.html5Mode(!0)}]),app.run(["$rootScope","$location","$route","Auth","$http",function($rootScope,$location,$route,Auth,$http){var auth=new Auth;auth.checkUser(function(cookie_obj){cookie_obj&&($http.defaults.headers.common["x-access-token"]=cookie_obj.token)}),$rootScope.$on("$routeChangeStart",function(event,next,current){$rootScope.path=$location.path(),auth.checkUser(function(cookie_obj){cookie_obj&&($http.defaults.headers.common["x-access-token"]=cookie_obj.token);var nextPath=$location.path();$route.routes[nextPath];1==next.needAuth&&void 0==cookie_obj?$location.path("/login"):"/login"!=nextPath&&"/"!=nextPath||void 0==cookie_obj||$location.path("/home")})}),$rootScope.$on("$routeChangeSuccess",function(event,current,previous){$rootScope.title=$route.current.title})}]),app.controller("HomeCtrl",["$cookies","$location",function($cookies,$location){var self=this;self.user=JSON.parse($cookies.get("api_auth")).user,self.logout=function(){$cookies.remove("api_auth"),$location.path("/login")}}]),app.controller("LoginCtrl",["$location","Auth","$http",function($location,Auth,$http){var self=this;self.user_email="",self.user_password="",self.auth=new Auth,self.user_login=function(){if(self.messageError="",""!=self.user_email&&""!=self.user_password){self.email_error=self.pass_error=!1;var user_obj={email:self.user_email,password:self.user_password};self.auth.loginUser(user_obj,function(result){1==result?$location.path("/home").replace():self.messageError="Usuário ou senha incorretos!"})}else""==self.user_email?(self.email_error=!0,self.messageError="Preencha o campo de email"):(self.pass_error=!0,self.messageError="Preencha o campo de senha")}}]),app.controller("ProductCtrl",["$location","$routeParams","$cookies","$http",function($location,$routeParams,$cookies,$http){var self=this;if(self.user=JSON.parse($cookies.get("api_auth")).user,self.messageError="",self.product={available_marketplace:!1,active:!1,tags:[]},self.allTags=[],self.allCategories=["cat1","cat2","cat3"],self.getAllTags=function(){$http.get(API_HOST+"tags").then(function(res){self.allTags=res.data})},self.getAllTags(),self.getProductById=function(product_id){$http.get(API_HOST+"product/"+product_id).then(function(res){self.product=res.data})},$routeParams.product_id){self.getProductById($routeParams.product_id)}else self.selectedCategories=[];self.save=function(){self.validForm(function(hasError){hasError||$http.post(API_HOST+"product/",self.product).then(function(res){res.data.result&&(self.messageError="Produto adicionado com sucesso!",self.product={available_marketplace:!1,active:!1,tags:[]})})})},self.update=function(){self.validForm(function(hasError){hasError||$http.put(API_HOST+"product/"+self.product._id,self.product).then(function(res){res.data.message&&(self.messageError="Produto alterado com sucesso!",self.product=res.data.result)})})},self.validForm=function(fnCallback){var hasError=!1;self.messageError="",self.product_name_error=self.product_code_error=self.product_price_error=self.product_stock_error=self.product_description_error=!1,""==self.product.name||void 0==self.product.name?(self.product_name_error=!0,self.messageError="Preencha o campo de nome",hasError=!0):""==self.product.code||void 0==self.product.code?(self.product_code_error=!0,self.messageError="Preencha o campo de código",hasError=!0):""==self.product.price||void 0==self.product.price?(self.product_price_error=!0,self.messageError="Preencha o campo de preço",hasError=!0):""==self.product.stock||void 0==self.product.stock?(self.product_stock_error=!0,self.messageError="Preencha o campo de estoque",hasError=!0):""!=self.product.description&&void 0!=self.product.description||(self.product_description_error=!0,self.messageError="Preencha o campo de descrição",hasError=!0),void 0!=fnCallback&&fnCallback(hasError)},self.newUrl=function(name){var new_url=name.toLowerCase();return new_url=new_url.replace(/[^\w\s]/gi,"").replace(/\s/g,"-")},self.updateUrl=function(value){self.product.url=self.newUrl(value)},self.validateUrl=function(){var notAllowSpecialChars=/\`|\~|\!|\@|\#|\$|\%|\^|\&|\*|\(|\)|\+|\=|\[|\{|\]|\}|\||\\|\'|\<|\,|\.|\>|\?|\/|\""|\;|\:|\_/g;self.product.url=self.product.url.replace(/\s/g,"-").replace(notAllowSpecialChars,"").toLowerCase()},self.tagsToLower=function(){if(self.product.tags.length<=0)self.product.tags=[];else{var tags=[],notAllowSpecialChars=/\`|\~|\!|\@|\#|\$|\%|\^|\&|\*|\(|\)|\+|\=|\[|\{|\]|\}|\||\\|\'|\<|\,|\.|\>|\?|\/|\""|\;|\:|\_|\s/g;self.product.tags.forEach(function(el,ind){tags.push(el.replace(notAllowSpecialChars,"").toLowerCase())}),self.product.tags=tags}},self.logout=function(){$cookies.remove("api_auth"),$location.path("/login")}}]),app.controller("ProductsCtrl",["$cookies","$http","$location",function($cookies,$http,$location){var self=this;self.user=JSON.parse($cookies.get("api_auth")).user,self.searchProduct=function(){""!=self.search_input&&void 0!=self.search_input?$http.get(API_HOST+"search-products/"+self.search_input).then(function(res){self.products=res.data,self.count=self.products.length}):self.getAllProducts()},self.getAllProducts=function(){$http.get(API_HOST+"products").then(function(res){self.products=res.data,self.count=self.products.length})},self.logout=function(){$cookies.remove("api_auth"),$location.path("/login")},self.count=0,self.getAllProducts()}]),app.factory("Auth",["$http","$location","$cookies",function($http,$location,$cookies){function Auth(){this.token="",this.loginUser=function(user_obj,fncallback){$http({method:"POST",url:API_HOST+"login/",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(obj){var str=[];for(var p in obj)str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]));return str.join("&")},data:{email:user_obj.email,password:user_obj.password}}).then(function(response){$cookies.put("api_auth",JSON.stringify(response.data)),void 0!=fncallback&&fncallback(!0)},function(response){void 0!=fncallback&&fncallback(!1)})},this.checkUser=function(fncallback){var token=void 0!=$cookies.get("api_auth")?JSON.parse($cookies.get("api_auth")):void 0;void 0!=fncallback&&fncallback(token)}}return Auth}]),$(function(){$(document).on("click",".dropdown",function(e){e.preventDefault(),$(this).find(".dropdown-submenu").slideToggle(200)})});